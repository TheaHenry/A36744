#include "A36744.h"
#include "FIRMWARE_VERSION.h"


// This is the firmware for Interface Board


_FOSC(ECIO & CSW_FSCM_OFF); 
_FWDT(WDT_ON & WDTPSA_512 & WDTPSB_8);  // 8 Second watchdog timer 
_FBORPOR(PWRT_64 & BORV_45 & PBOR_OFF & MCLR_EN);
_FBS(WR_PROTECT_BOOT_OFF & NO_BOOT_CODE & NO_BOOT_EEPROM & NO_BOOT_RAM);
_FSS(WR_PROT_SEC_OFF & NO_SEC_CODE & NO_SEC_EEPROM & NO_SEC_RAM);
_FGS(CODE_PROT_OFF);
_FICD(PGD);


#define STATE_STARTUP       0x10
#define STATE_WARMUP	    0x20
#define STATE_READY         0x30
#define STATE_SHUTDOWN      0x40


#define EK_VOLTAGE_TABLE_VALUES 10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10500,10510,10510,10510,10510,10510,10510,10510,10510,10510,10510,10510,10510,10510,10510,10510,10510,10510,10510,10510,10510,10520,10520,10520,10520,10520,10520,10520,10520,10520,10520,10520,10520,10520,10520,10520,10520,10520,10520,10520,10520,10520,10530,10530,10530,10530,10530,10530,10530,10530,10530,10530,10530,10530,10530,10530,10530,10530,10530,10530,10530,10530,10530,10540,10540,10540,10540,10540,10540,10540,10540,10540,10540,10540,10540,10540,10540,10540,10540,10540,10540,10540,10550,10550,10550,10550,10550,10550,10550,10550,10550,10550,10550,10550,10550,10550,10550,10550,10550,10550,10550,10560,10560,10560,10560,10560,10560,10560,10560,10560,10560,10560,10560,10560,10560,10560,10560,10560,10560,10560,10560,10570,10570,10570,10570,10570,10570,10570,10570,10570,10570,10570,10570,10570,10570,10570,10570,10570,10570,10570,10570,10580,10580,10580,10580,10580,10580,10580,10580,10580,10580,10580,10580,10580,10580,10580,10580,10580,10580,10590,10590,10590,10590,10590,10590,10590,10590,10590,10590,10590,10590,10590,10590,10590,10590,10590,10590,10590,10590,10600,10600,10600,10600,10600,10600,10600,10600,10600,10600,10600,10600,10600,10600,10600,10600,10600,10600,10600,10610,10610,10610,10610,10610,10610,10610,10610,10610,10610,10610,10610,10610,10610,10610,10610,10610,10610,10620,10620,10620,10620,10620,10620,10620,10620,10620,10620,10620,10620,10620,10620,10620,10620,10620,10620,10630,10630,10630,10630,10630,10630,10630,10630,10630,10630,10630,10630,10630,10630,10630,10630,10630,10630,10640,10640,10640,10640,10640,10640,10640,10640,10640,10640,10640,10640,10640,10640,10640,10640,10640,10640,10650,10650,10650,10650,10650,10650,10650,10650,10650,10650,10650,10650,10650,10650,10650,10650,10650,10660,10660,10660,10660,10660,10660,10660,10660,10660,10660,10660,10660,10660,10660,10660,10660,10660,10660,10670,10670,10670,10670,10670,10670,10670,10670,10670,10670,10670,10670,10670,10670,10670,10670,10670,10680,10680,10680,10680,10680,10680,10680,10680,10680,10680,10680,10680,10680,10680,10680,10680,10680,10690,10690,10690,10690,10690,10690,10690,10690,10690,10690,10690,10690,10690,10690,10690,10690,10690,10700,10700,10700,10700,10700,10700,10700,10700,10700,10700,10700,10700,10700,10700,10700,10700,10710,10710,10710,10710,10710,10710,10710,10710,10710,10710,10710,10710,10710,10710,10710,10710,10720,10720,10720,10720,10720,10720,10720,10720,10720,10720,10720,10720,10720,10720,10720,10720,10720,10730,10730,10730,10730,10730,10730,10730,10730,10730,10730,10730,10730,10730,10730,10730,10740,10740,10740,10740,10740,10740,10740,10740,10740,10740,10740,10740,10740,10740,10740,10750,10750,10750,10750,10750,10750,10750,10750,10750,10750,10750,10750,10750,10750,10750,10750,10760,10760,10760,10760,10760,10760,10760,10760,10760,10760,10760,10760,10760,10760,10760,10770,10770,10770,10770,10770,10770,10770,10770,10770,10770,10770,10770,10770,10770,10770,10780,10780,10780,10780,10780,10780,10780,10780,10780,10780,10780,10780,10780,10780,10780,10790,10790,10790,10790,10790,10790,10790,10790,10790,10790,10790,10790,10790,10790,10800,10800,10800,10800,10800,10800,10800,10800,10800,10800,10800,10800,10800,10800,10810,10810,10810,10810,10810,10810,10810,10810,10810,10810,10810,10810,10810,10810,10820,10820,10820,10820,10820,10820,10820,10820,10820,10820,10820,10820,10820,10820,10830,10830,10830,10830,10830,10830,10830,10830,10830,10830,10830,10840,10840,10840,10840,10840,10840,10840,10840,10840,10840,10840,10840,10840,10840,10840,10840,10850,10850,10850,10850,10850,10850,10850,10850,10850,10850,10860,10860,10860,10860,10860,10860,10860,10860,10860,10860,10860,10860,10860,10860,10860,10870,10870,10870,10870,10870,10870,10870,10870,10870,10870,10870,10870,10870,10870,10870,10880,10880,10880,10880,10880,10880,10880,10880,10880,10890,10890,10890,10890,10890,10890,10890,10890,10890,10890,10890,10890,10890,10900,10900,10900,10900,10900,10900,10900,10900,10900,10900,10900,10900,10900,10910,10910,10910,10910,10910,10910,10910,10910,10910,10910,10910,10910,10920,10920,10920,10920,10920,10920,10920,10920,10920,10920,10920,10930,10930,10930,10930,10930,10930,10930,10930,10930,10930,10930,10940,10940,10940,10940,10940,10940,10940,10940,10940,10940,10940,10950,10950,10950,10950,10950,10950,10950,10950,10950,10950,10950,10950,10950,10950,10960,10960,10960,10960,10960,10960,10960,10960,10960,10970,10970,10970,10970,10970,10970,10970,10970,10970,10970,10980,10980,10980,10980,10980,10980,10980,10980,10980,10980,10980,10980,10990,10990,10990,10990,10990,10990,10990,10990,10990,11000,11000,11000,11000,11000,11000,11000,11000,11000,11000,11000,11010,11010,11010,11010,11010,11010,11010,11010,11010,11010,11020,11020,11020,11020,11020,11020,11020,11020,11020,11020,11030,11030,11030,11030,11030,11030,11030,11030,11040,11040,11040,11040,11040,11040,11040,11040,11040,11050,11050,11050,11050,11050,11050,11050,11050,11050,11050,11050,11060,11060,11060,11060,11060,11060,11060,11060,11060,11070,11070,11070,11070,11070,11070,11070,11070,11080,11080,11080,11080,11080,11080,11080,11080,11080,11080,11090,11090,11090,11090,11090,11090,11090,11100,11100,11100,11100,11100,11100,11100,11100,11100,11110,11110,11110,11110,11110,11110,11110,11120,11120,11120,11120,11120,11120,11120,11120,11130,11130,11130,11130,11130,11130,11130,11130,11140,11140,11140,11140,11140,11140,11140,11140,11150,11150,11150,11150,11150,11150,11150,11150,11150,11160,11160,11160,11160,11160,11160,11170,11170,11170,11170,11170,11170,11170,11170,11180,11180,11180,11180,11180,11180,11180,11190,11190,11190,11190,11190,11190,11190,11200,11200,11200,11200,11200,11200,11200,11210,11210,11210,11210,11210,11210,11210,11220,11220,11220,11220,11220,11220,11230,11230,11230,11230,11230,11230,11240,11240,11240,11240,11240,11240,11240,11250,11250,11250,11250,11250,11260,11260,11260,11260,11260,11260,11260,11270,11270,11270,11270,11270,11270,11280,11280,11280,11280,11280,11290,11290,11290,11290,11290,11290,11290,11300,11300,11300,11300,11300,11310,11310,11310,11310,11310,11320,11320,11320,11320,11320,11320,11330,11330,11330,11330,11330,11340,11340,11340,11340,11340,11350,11350,11350,11350,11350,11360,11360,11360,11360,11360,11370,11370,11370,11370,11370,11380,11380,11380,11380,11390,11390,11390,11390,11390,11400,11400,11400,11400,11410,11410,11410,11410,11410,11420,11420,11420,11420,11430,11430,11430,11430,11440,11440,11440,11440,11450,11450,11450,11450,11460,11460,11460,11460,11470,11470,11470,11470,11480,11480,11480,11480,11490,11490,11490,11490,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500,11500

#define TOP_VOLTAGE_TABLE_VALUES 100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,100,101,101,101,101,101,101,101,101,101,101,101,101,101,101,101,101,101,101,101,101,101,102,102,102,102,102,102,102,102,102,102,102,102,102,102,102,102,102,102,102,102,102,102,102,102,102,102,102,102,103,103,103,103,103,103,103,103,103,103,103,103,103,103,103,103,103,103,103,103,104,104,104,104,104,104,104,104,104,104,104,104,104,104,104,104,104,104,104,104,104,104,104,104,104,104,105,105,105,105,105,105,105,105,105,105,105,105,105,105,105,105,105,105,105,105,105,105,105,105,105,105,106,106,106,106,106,106,106,106,106,106,106,106,106,106,106,106,106,106,106,106,106,106,106,106,106,106,107,107,107,107,107,107,107,107,107,107,107,107,107,107,107,107,107,107,108,108,108,108,108,108,108,108,108,108,108,108,108,108,108,108,108,108,108,108,108,108,108,108,109,109,109,109,109,109,109,109,109,109,109,109,109,109,109,109,109,109,109,109,109,109,109,109,109,109,109,109,109,109,110,110,110,110,110,110,110,110,110,110,110,110,110,110,110,110,110,110,110,110,110,110,110,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,111,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,112,113,113,113,113,113,113,113,113,113,113,113,113,113,113,113,113,113,113,113,113,113,114,114,114,114,114,114,114,114,114,114,114,114,114,114,114,114,114,114,114,114,114,114,114,114,114,114,114,115,115,115,115,115,115,115,115,115,115,115,115,115,115,115,115,115,115,115,115,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,116,117,117,117,117,117,117,117,117,117,117,117,117,117,117,117,117,117,117,117,117,117,117,117,117,118,118,118,118,118,118,118,118,118,118,118,118,118,118,118,118,118,118,118,118,118,118,118,118,118,119,119,119,119,119,119,119,119,119,119,119,119,119,119,119,119,119,119,119,119,119,119,119,119,119,119,119,119,120,120,120,120,120,120,120,120,120,120,120,120,120,120,120,120,120,120,120,120,120,120,121,121,121,121,121,121,121,121,121,121,121,121,121,121,121,121,121,121,121,121,121,121,121,121,121,121,121,122,122,122,122,122,122,122,122,122,122,122,122,122,122,122,122,122,122,122,122,122,122,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,123,124,124,124,124,124,124,124,124,124,124,124,124,124,124,124,124,124,124,124,124,124,124,124,124,124,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,125,126,126,126,126,126,126,126,126,126,126,126,126,126,126,126,126,126,126,126,126,126,126,126,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,127,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,128,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,129,130,130,130,130,130,130,130,130,130,130,130,130,130,130,130,130,130,130,130,130,130,130,130,130,131,131,131,131,131,131,131,131,131,131,131,131,131,131,131,131,131,131,131,131,131,131,131,131,132,132,132,132,132,132,132,132,132,132,132,132,132,132,132,132,132,132,132,132,132,132,132,133,133,133,133,133,133,133,133,133,133,133,133,133,133,133,133,133,133,133,133,133,133,133,133,133,133,134,134,134,134,134,134,134,134,134,134,134,134,134,134,134,134,134,134,134,134,134,134,135,135,135,135,135,135,135,135,135,135,135,135,135,135,135,135,135,135,135,135,135,135,135,135,136,136,136,136,136,136,136,136,136,136,136,136,136,136,136,136,136,136,136,136,136,136,136,136,137,137,137,137,137,137,137,137,137,137,137,137,137,137,137,137,137,137,137,137,137,137,138,138,138,138,138,138,138,138,138,138,138,138,138,138,138,138,138,138,138,138,138,138,138,139,139,139,139,139,139,139,139,139,139,139,139,139,139,139,139,139,139,139,139,139,139,139,139,140,140,140,140,140,140,140,140,140,140,140,140,140,140,140,140,140,140,140,140,140,141,141,141,141,141,141,141,141,141,141,141,141,141,141,141,141,141,141,141,141,141,141,142,142,142,142,142,142,142,142,142,142,142,142,142,142,142,142,142,142,142,142,142,142,143,143,143,143,143,143,143,143,143,143,143,143,143,143,143,143,143,143,143,143,143,143,144,144,144,144,144,144,144,144,144,144,144,144,144,144,144,144,144,144,144,144,144,144,144,145,145,145,145,145,145,145,145,145,145,145,145,145,145,145,145,145,145,145,145,145,145,146,146,146,146,146,146,146,146,146,146,146,146,146,146,146,146,146,146,146,146,146,147,147,147,147,147,147,147,147,147,147,147,147,147,147,147,147,147,147,147,147,147,148,148,148,148,148,148,148,148,148,148,148,148,148,148,148,148,148,148,148,148,149,149,149,149,149,149,149,149,149,149,149,149,149,149,149,149,149,149,149,149,149,149,150,150,150,150,150,150,150,150,150,150,150,150,150,150,150,150,150,150,150,150,150,151,151,151,151,151,151,151,151,151,151,151,151,151,151,151,151,151,151,151,151,152,152,152,152,152,152,152,152,152,152,152,152,152,152,152,152,152,152,152,152,152,153,153,153,153,153,153,153,153,153,153,153,153,153,153,153,153,153,153,153,153,153,154,154,154,154,154,154,154,154,154,154,154,154,154,154,154,154,154,154,154,155,155,155,155,155,155,155,155,155,155,155,155,155,155,155,155,155,155,155,156,156,156,156,156,156,156,156,156,156,156,156,156,156,156,156,156,156,156,156,157,157,157,157,157,157,157,157,157,157,157,157,157,157,157,157,157,157,157,157,158,158,158,158,158,158,158,158,158,158,158,158,158,158,158,158,158,158,159,159,159,159,159,159,159,159,159,159,159,159,159,159,159,159,159,159,159,159,160,160,160,160,160,160,160,160,160,160,160,160,160,160,160,160,160,160,160,161,161,161,161,161,161,161,161,161,161,161,161,161,161,161,161,161,161,162,162,162,162,162,162,162,162,162,162,162,162,162,162,162,162,162,162,163,163,163,163,163,163,163,163,163,163,163,163,163,163,163,163,163,163,164,164,164,164,164,164,164,164,164,164,164,164,164,164,164,164,164,164,165,165,165,165,165,165,165,165,165,165,165,165,165,165,165,165,165,166,166,166,166,166,166,166,166,166,166,166,166,166,166,166,166,166,166,167,167,167,167,167,167,167,167,167,167,167,167,167,167,167,167,167,168,168,168,168,168,168,168,168,168,168,168,168,168,168,168,168,168,169,169,169,169,169,169,169,169,169,169,169,169,169,169,169,169,169,170,170,170,170,170,170,170,170,170,170,170,170,170,170,170,170,171,171,171,171,171,171,171,171,171,171,171,171,171,171,171,171,172,172,172,172,172,172,172,172,172,172,172,172,172,172,172,172,172,173,173,173,173,173,173,173,173,173,173,173,173,173,173,173,174,174,174,174,174,174,174,174,174,174,174,174,174,174,174,175,175,175,175,175,175,175,175,175,175,175,175,175,175,175,175,176,176,176,176,176,176,176,176,176,176,176,176,176,176,176,177,177,177,177,177,177,177,177,177,177,177,177,177,177,177,178,178,178,178,178,178,178,178,178,178,178,178,178,178,178,179,179,179,179,179,179,179,179,179,179,179,179,179,179,180,180,180,180,180,180,180,180,180,180,180,180,180,180,181,181,181,181,181,181,181,181,181,181,181,181,181,181,182,182,182,182,182,182,182,182,182,182,182,182,182,182,183,183,183,183,183,183,183,183,183,183,183,184,184,184,184,184,184,184,184,184,184,184,184,184,184,184,184,185,185,185,185,185,185,185,185,185,185,186,186,186,186,186,186,186,186,186,186,186,186,186,186,186,187,187,187,187,187,187,187,187,187,187,187,187,187,187,187,188,188,188,188,188,188,188,188,188,189,189,189,189,189,189,189,189,189,189,189,189,189,190,190,190,190,190,190,190,190,190,190,190,190,190,191,191,191,191,191,191,191,191,191,191,191,191,192,192,192,192,192,192,192,192,192,192,192,193,193,193,193,193,193,193,193,193,193,193,194,194,194,194,194,194,194,194,194,194,194,195,195,195,195,195,195,195,195,195,195,195,195,195,195,196,196,196,196,196,196,196,196,196,197,197,197,197,197,197,197,197,197,197,198,198,198,198,198,198,198,198,198,198,198,198,199,199,199,199,199,199,199,199,199,200,200,200,200,200,200,200,200,200,200,200,201,201,201,201,201,201,201,201,201,201,202,202,202,202,202,202,202,202,202,202,203,203,203,203,203,203,203,203,204,204,204,204,204,204,204,204,204,205,205,205,205,205,205,205,205,205,205,205,206,206,206,206,206,206,206,206,206,207,207,207,207,207,207,207,207,208,208,208,208,208,208,208,208,208,208,209,209,209,209,209,209,209,210,210,210,210,210,210,210,210,210,211,211,211,211,211,211,211,212,212,212,212,212,212,212,212,213,213,213,213,213,213,213,213,214,214,214,214,214,214,214,214,215,215,215,215,215,215,215,215,215,216,216,216,216,216,216,217,217,217,217,217,217,217,217,218,218,218,218,218,218,218,219,219,219,219,219,219,219,220,220,220,220,220,220,220,221,221,221,221,221,221,221,222,222,222,222,222,222,223,223,223,223,223,223,224,224,224,224,224,224,224,225,225,225,225,225,226,226,226,226,226,226,226,227,227,227,227,227,227,228,228,228,228,228,229,229,229,229,229,229,229,230,230,230,230,230,231,231,231,231,231,232,232,232,232,232,232,233,233,233,233,233,234,234,234,234,234,235,235,235,235,235,236,236,236,236,236,237,237,237,237,237,238,238,238,238,239,239,239,239,239,240,240,240,240,241,241,241,241,241,242,242,242,242,243,243,243,243,244,244,244,244,245,245,245,245,246,246,246,246,247,247,247,247,248,248,248,248,249,249,249,249,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250,250

const unsigned int EkReferenceVoltageTable[4096] = {EK_VOLTAGE_TABLE_VALUES};  // This table defines the cathode reference voltage per the resistor value
const unsigned int TopReferenceVoltageTable[4096]  = {TOP_VOLTAGE_TABLE_VALUES};   // This table defines the top reference voltage per the resistor value


void DoStateMachine(void);
void InitializeA36744(void);
int CheckHeaterFlt (void);
void CheckAndUpdateShortHeat(void);

ControlData global_data_A36744;
LTC265X U2_LTC2654;


int main(void) {
  global_data_A36744.control_state = STATE_STARTUP;
  while (1) {
    DoStateMachine();
  }
}

void DoStateMachine(void) {
  switch (global_data_A36744.control_state) {

  case STATE_STARTUP:
    InitializeA36744();
	
    global_data_A36744.heater_warmup_timer = HTR_WARMUP_DEFAULT_DURATION;
	if (PIN_SHORT_RESET_NOT == 0) //checking power interrupt duration
	{
		global_data_A36744.heater_warmup_timer = HTR_WARMUP_RECOVERY_DURATION;
	}
	else
	{
		 _ADON = 1;
		while (global_data_A36744.adc_conversion_complete == 0);
		 _ADON = 0;

		global_data_A36744.cathode_set_voltage = EkReferenceVoltageTable[global_data_A36744.cathode_lookup_index];
		global_data_A36744.top_set_voltage = TopReferenceVoltageTable[global_data_A36744.top_lookup_index];
		global_data_A36744.cathode_dac_setting_scaled = ETMScaleFactor16(global_data_A36744.cathode_set_voltage,MACRO_DEC_TO_SCALE_FACTOR_16(CATHODE_FIXED_SCALE),CATHODE_FIXED_OFFSET);
		global_data_A36744.cathode_dac_setting_scaled <<=4;
                global_data_A36744.top_dac_setting_scaled = ETMScaleFactor16(global_data_A36744.top_set_voltage,MACRO_DEC_TO_SCALE_FACTOR_16(TOP_FIXED_SCALE),TOP_FIXED_OFFSET);
                global_data_A36744.top_dac_setting_scaled <<=4;

                WriteLTC265X (&U2_LTC2654, LTC265X_WRITE_AND_UPDATE_DAC_B,global_data_A36744.cathode_dac_setting_scaled);
		WriteLTC265X (&U2_LTC2654, LTC265X_WRITE_AND_UPDATE_DAC_A,global_data_A36744.top_dac_setting_scaled);

	}

    global_data_A36744.control_state = STATE_WARMUP;
    break;
	
  case STATE_WARMUP:
        PIN_STANDBY = 1;
	PIN_HTR_ENABLE_NOT = 0;
        unsigned int flash_LED_timer =10;
	global_data_A36744.heater_set_voltage = HEATER_DEFAULT_VOLTAGE;
	while (global_data_A36744.heater_warmup_timer > 0 && global_data_A36744.control_state == STATE_WARMUP)
	{
            PIN_LED_A_RED = 0;
            global_data_A36744.heater_dac_setting_scaled = ETMScaleFactor16(global_data_A36744.heater_set_voltage,MACRO_DEC_TO_SCALE_FACTOR_16(HEATER_FIXED_SCALE),HEATER_FIXED_OFFSET);
            global_data_A36744.heater_dac_setting_scaled <<=4;
            WriteLTC265X (&U2_LTC2654, LTC265X_WRITE_AND_UPDATE_DAC_C,global_data_A36744.heater_dac_setting_scaled);

            if (_T3IF == 1)
		{
                    _T3IF = 0;
                    global_data_A36744.heater_warmup_timer--;
                    flash_LED_timer--;
		}
		
            if (flash_LED_timer==0) //change state of heater LED every 0.5 sec
		{
                    flash_LED_timer = 50;
                    if (PIN_HTR_LED==0)
                        PIN_HTR_LED = 1;
                    else
                        PIN_HTR_LED = 0;
		}
            CheckAndUpdateShortHeat();
             
            if (global_data_A36744.heater_warmup_timer <= HV_ON_DELAY)
                {
                    PIN_PIC_HV_ON = 0 ;
                }
		
            if (_INT1IF == 1)
                {
                    global_data_A36744.control_state = STATE_SHUTDOWN;
		}

	}
        global_data_A36744.heater_set_voltage = HEATER_DEFAULT_VOLTAGE;
        global_data_A36744.heater_dac_setting_scaled = ETMScaleFactor16(global_data_A36744.heater_set_voltage,MACRO_DEC_TO_SCALE_FACTOR_16(HEATER_FIXED_SCALE),HEATER_FIXED_OFFSET);
        global_data_A36744.heater_dac_setting_scaled <<=4;
        WriteLTC265X (&U2_LTC2654, LTC265X_WRITE_AND_UPDATE_DAC_C,global_data_A36744.heater_dac_setting_scaled);
        PIN_HTR_LED = 1;
        global_data_A36744.heater_warmup_timer = HTR_WARMUP_DEFAULT_DURATION;
	PIN_LED_A_RED = 1;
        
	PIN_ETM_RESET_DETECT = 1;
	global_data_A36744.control_state = STATE_READY;
    break;

  case STATE_READY:
  /********************************************************************************************** 
  During the ready state, the controller checks for the following conditions:
	1. Heater Back-off - if there is no pulse input (Pretrans) for a given amount of time 
		heater back-off window), then the heater voltage will be backed off to heater back-off voltage.	
		Implementation notes - back-off counter is always counting back with the 10ms timer. 
		Pretrans is used as a latched input (external interrupt), which asserts its flag on every 
		rising edge. As long as a rising edge is detected, the back-off counter is reset. If there 
		is no rising edge for long enough, the counter will reach zero and lower the heater voltage.
	2. Arc fault - if a number of repeated arcs (arcs repeated) is detected within a given 
		amount of time (arc fault window max), then an arc fault is generated.
		Implementation notes - whenever an arc is detected the arc counter increments, 
		when the arc time window elapses, the arc counter decreases. This effectively counts the arcs 
		within the last time window. If that value exceeds the allowable number, a arc fault is asserted.  
	3. Check for Volterrn condition- once asserted, the power supply needs to be shut down. When cleared, 
		the power supply needs to be brought up again and start the heater warm-up sequence.
		Implementation notes- Volterrn input is an interrupt. When the input changes from hi to low,
		an interrupt is asserted and the state changes to SHUTDOWN. Once in the SHUTDOWN state, the 
		power supply shuts itself down (including the grid), and the interrupt is re-configured
		to detect a rising edge. The only way to get out of the SHUTDOWN state is by Volterrn going hi.
  ****************************************************************************************************/
  
	PIN_STANDBY = 0;
        _T3IF = 0;
	_INT4IF = 0;
	_INT2IE = 0;
    while (global_data_A36744.control_state == STATE_READY) {
		
		if (_INT4IF == 1) // keep heater at its default values as long as pulses are coming in.
		{
			_INT4IF = 0;
			global_data_A36744.heater_backoff_time_counter = HTR_BACKOFF_WINDOW;
			global_data_A36744.heater_set_voltage = HEATER_DEFAULT_VOLTAGE;
		}		
			
		if (_T3IF == 1)
		{
			_T3IF = 0;
			global_data_A36744.heater_backoff_time_counter--; 
			if (global_data_A36744.heater_backoff_time_counter == 0) // change heater voltage to backoff value if no pulses came in for x amount of time.
			{
				global_data_A36744.heater_set_voltage = HEATER_BACKOFF_VOLTAGE;
			}
			global_data_A36744.arc_timer++;			
		}
		global_data_A36744.heater_dac_setting_scaled = ETMScaleFactor16(global_data_A36744.heater_set_voltage,MACRO_DEC_TO_SCALE_FACTOR_16(HEATER_FIXED_SCALE),HEATER_FIXED_OFFSET);
		global_data_A36744.heater_dac_setting_scaled <<=4;
                WriteLTC265X (&U2_LTC2654, LTC265X_WRITE_AND_UPDATE_DAC_C,global_data_A36744.heater_dac_setting_scaled);
	  
	  if (_INT2IF == 1)
	  {
		  _INT2IF = 0;
		  global_data_A36744.arc_counter++;
	  }
	  if (global_data_A36744.arc_timer >= ARC_FLT_WINDOW_MAX)
	  {
		  if (global_data_A36744.arc_counter != 0)
		  {
			 global_data_A36744.arc_counter--;
		  }
		  global_data_A36744.arc_timer = 0;
	  }
	  
	  if (global_data_A36744.arc_counter >= ARCS_REPEATED)
	  { 
		global_data_A36744.arc_counter=0;
		PIN_PIC_ARC_FLT_NOT = 0;
		while (_T3IF == 0);
                _T3IF = 1;
                while (_T3IF == 0);
		PIN_PIC_ARC_FLT_NOT = 1;
		_INT2IF = 0;
	  }
	  
	if (_INT1IF == 1) 
	{
		global_data_A36744.control_state = STATE_SHUTDOWN;
	}
	 
    }
    break;
     
    
 case STATE_SHUTDOWN:
        PIN_STANDBY = 1;
	_INT1IE = 0;
	_INT1EP = 0; //change interrupt to detect rising edge (removal of the volterrn condition)
	_INT1IF = 0;

	PIN_PIC_HV_ON = 1;
	PIN_HTR_ENABLE_NOT = 1;
        unsigned int i;
        for (i=500; i<=0; i--)
        {
            while (_T3IF == 0);
            _T3IF = 0;
        }

	PIN_GRID_ENABLE = 0;
	if (CheckHeaterFlt())
		PIN_HTR_LED = 0;
	else
		PIN_HTR_LED = 1;

	while (global_data_A36744.control_state == STATE_SHUTDOWN) {
     	 if (_INT1IF == 1)
		{
		 PIN_GRID_ENABLE = 1;
		 for (i=500; i<=0; i--)
                 {
                    while (_T3IF == 0);
                     _T3IF = 0;
                 }
		 global_data_A36744.heater_set_voltage = HEATER_DEFAULT_VOLTAGE;
		 global_data_A36744.control_state = STATE_WARMUP;
                 global_data_A36744.heater_warmup_timer = HTR_WARMUP_DEFAULT_DURATION;
		 _INT1EP = 1 ;
		 _INT1IF = 0;
		 //_INT1IE = 1;
		}
		if (CheckHeaterFlt())
			PIN_HTR_LED = 0;
		else
			PIN_HTR_LED = 1;
	 }
	break;
	
  default:
    global_data_A36744.control_state = STATE_READY;
    break;

  }
}

void InitializeA36744(void) {

  

  PIN_PIC_ARC_FLT_NOT = 1;
  PIN_HTR_ENABLE_NOT = 1;

  PIN_STANDBY   = 0;
  PIN_POR   = 0;
  PIN_PIC_HV_ON   = 0;
  PIN_GRID_ENABLE   = 1;
  //PIN_ETM_RESET_DETECT
  PIN_OVERLOAD = 0;
  PIN_PIC_ERROR = 0;
  PIN_HTR_LED = 1;
  PIN_PIC_VOLTERRN_NOT = 1;
  //PIN_TEST_POINT_A =0;
  PIN_LED_OPERATIONAL_GREEN = 0;
  PIN_LED_A_RED = 0;


  //Timer3 setup
  PR3 = PR3_VALUE_10_MILLISECONDS;
  T3CON = T3CON_VALUE;
  _T3IF = 0;
  _T3IE = 0;

    // Initialize internal ADC
  // ---- Configure the dsPIC ADC Module ------------ //
  ADCON1 = ADCON1_SETTING;             // Configure the high speed ADC module based on H file parameters
  ADCON2 = ADCON2_SETTING;             // Configure the high speed ADC module based on H file parameters
  ADCON3 = ADCON3_SETTING_STARTUP;             // Configure the high speed ADC module based on H file parameters
  ADCHS  = ADCHS_SETTING;              // Configure the high speed ADC module based on H file parameters
  
  ADPCFG = ADPCFG_SETTING;             // Set which pins are analog and which are digital I/O
  ADCSSL = ADCSSL_SETTING_STARTUP; 	// Set which analog pins are scanned
  _ADIF = 0;
  _ADIP = 5; // This needs to be higher priority than the CAN interrupt (Which defaults to 4)
  _ADIE = 1;
 

  
// additional interrupt set-up
  //INT4 pretrans
  _INT4IF = 0;
  _INT4IP = 1;
  _INT4IE = 0;

  //INT2 arc detect
  _INT2IF = 0;
  _INT2IP = 4;
  _INT2IE = 0;

  // INT1 volterrn
  _INT1IF = 0;
  _INT1IP = 5;
  _INT1IE = 0;
  _INT1EP = 1;

  // Initialize LTC DAC
  SetupLTC265X(&U2_LTC2654, ETM_SPI_PORT_1, FCY_CLK, LTC265X_SPI_2_5_M_BIT, _PIN_RG15, _PIN_RC1);
  

  global_data_A36744.heater_set_voltage = HEATER_DEFAULT_VOLTAGE;
  global_data_A36744.cathode_set_voltage = 0;
  global_data_A36744.top_set_voltage = 0;
 
  global_data_A36744.cathode_resistor_accumulator = 0;
  global_data_A36744.top_resistor_accumulator = 0;
  global_data_A36744.adc_conversion_complete = 0;

  global_data_A36744.heater_backoff_time_counter = HTR_BACKOFF_WINDOW;

  TRISA = A36744_TRISA_VALUE;
  TRISB = A36744_TRISB_VALUE;
  TRISC = A36744_TRISC_VALUE;
  TRISD = A36744_TRISD_VALUE;
  TRISF = A36744_TRISF_VALUE;
  TRISG = A36744_TRISG_VALUE;
}

int CheckHeaterFlt (void) {
if (PIN_HTR_SUM_FLT && PIN_HTR_OC_FLT && PIN_HTR_UC_FLT)
    return 0;
return 1;
    /*    int i = 0;
    if (PIN_HTR_SUM_FLT > 0)
    {
        i++;
    }
    if (PIN_HTR_OC_FLT > 0)
    {
        i++;
    }
    if (PIN_HTR_UC_FLT > 0)
    {
       i++;
    }*/
//    return (PIN_HTR_SUM_FLT && PIN_HTR_OC_FLT && PIN_HTR_UC_FLT);
}

void CheckAndUpdateShortHeat(void){
    if (PIN_SHORT_HEAT == 1 && global_data_A36744.heater_set_voltage != HEATER_FAST_WARMUP_VOLTAGE)
	{
		global_data_A36744.heater_set_voltage = HEATER_FAST_WARMUP_VOLTAGE;
		if (global_data_A36744.heater_warmup_timer > HTR_WARMUP_SHORT_DURATION)
                       {
                            global_data_A36744.heater_warmup_timer = HTR_WARMUP_SHORT_DURATION;
                       }
	}
}


void __attribute__((interrupt, no_auto_psv)) _ADCInterrupt(void) {
  _ADIF = 0;
  
  // Copy Data From Buffer to RAM
  if (_BUFS) {
    // read ADCBUF 0-7
	global_data_A36744.cathode_resistor_accumulator += ADCBUF0;
	global_data_A36744.top_resistor_accumulator += ADCBUF1;
	global_data_A36744.cathode_resistor_accumulator += ADCBUF2;
	global_data_A36744.top_resistor_accumulator += ADCBUF3;
	global_data_A36744.cathode_resistor_accumulator += ADCBUF4;
	global_data_A36744.top_resistor_accumulator += ADCBUF5;
	global_data_A36744.cathode_resistor_accumulator += ADCBUF6;
	global_data_A36744.top_resistor_accumulator += ADCBUF7;
    
  } else {
    // read ADCBUF 8-15
    global_data_A36744.cathode_resistor_accumulator += ADCBUF8;
	global_data_A36744.top_resistor_accumulator += ADCBUF9;
	global_data_A36744.cathode_resistor_accumulator += ADCBUFA;
	global_data_A36744.top_resistor_accumulator += ADCBUFB;
	global_data_A36744.cathode_resistor_accumulator += ADCBUFC;
	global_data_A36744.top_resistor_accumulator += ADCBUFD;
	global_data_A36744.cathode_resistor_accumulator += ADCBUFE;
	global_data_A36744.top_resistor_accumulator += ADCBUFF;
    
  }
  
  global_data_A36744.accumulator_counter += 4;

  
  if (global_data_A36744.accumulator_counter >= 128) {
    global_data_A36744.accumulator_counter = 0;    
    
    global_data_A36744.top_resistor_accumulator >>= 7;  // This is now a 12 bit average of previous 128 samples 
	global_data_A36744.top_lookup_index = global_data_A36744.top_resistor_accumulator ;
	global_data_A36744.top_resistor_accumulator = 0;
	
	global_data_A36744.cathode_resistor_accumulator >>= 7;  // This is now a 12 bit average of previous 128 samples 
	global_data_A36744.cathode_lookup_index = global_data_A36744.cathode_resistor_accumulator ;
	global_data_A36744.cathode_resistor_accumulator = 0;
	
	global_data_A36744.adc_conversion_complete = 1;
  }
  
}

void __attribute__((interrupt, no_auto_psv)) _DefaultInterrupt(void) {
    Nop();
    Nop();
    Nop();

}

